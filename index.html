<html>
    <head>
        <title>bbb.canvas.js</title>
        <link href="./font/NotoSerifJapanese.css" rel="stylesheet" type="text/css">
        <style>
            html {
                height: 100%;
            }
            body {
                background-color: #000;
                padding: 0;
                margin: 0;
                color: #fff;
                font-family: 'Noto Serif Japanese', serif;
            }
            #canvas {
                position: fixed;
                top: 0;
                left: 0;
                z-index: -1;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }
            #menu {
                position: fixed;
                top: 40px;
                right: 40px;
                width: 200px;
                height: 30px;
            }
            a, a:active, a:visited {
                color: #fff;
            }
            a:hover {
                color: #bfb;
            }

            #main {
                margin: 40px;
            }
        </style>
    </head>
<body>
    <article id="main">
        <h1>bbb.canvas.js [<a href="https://github.com/2bbb/bbb-canvas-js">github</a>]</h1>
        <section id="contents">
            <select id="menu"></select>
            <code><pre id="code_example"></pre></code>
        </section>
        <sction id="dummy_contents"></section>
    </article>
    <canvas id="canvas"></canvas>
    <script src="./libs/jquery-3.2.1.min.js"></script>
    <script src="./src/bbb.js"></script>
    <script src="./src/bbb.math.js"></script>
    <script src="./src/bbb.noise.js"></script>
    <script src="./src/bbb.canvas.js"></script>
    <script>
        var drawTransformingNumber = (function() {
            var num_path = [
                [[0, 1], [0, 2], [1, 3], [2, 2], [2, 4], [3, 5], [4, 5]],
                [[0, 0], [0, 0], [1, 3], [2, 2], [2, 2], [3, 5], [4, 4]],
                [[0, 1], [0, 0], [1, 3], [2, 3], [2, 4], [3, 3], [4, 5]],
                [[0, 1], [0, 0], [1, 3], [2, 3], [2, 2], [3, 5], [4, 5]],
                [[0, 0], [0, 2], [1, 3], [2, 3], [2, 2], [3, 5], [4, 4]],
                [[0, 1], [0, 2], [1, 1], [2, 3], [2, 2], [3, 5], [4, 5]],
                [[0, 1], [0, 2], [1, 1], [2, 3], [2, 4], [3, 5], [4, 5]],
                [[0, 1], [0, 2], [1, 3], [2, 2], [2, 2], [3, 5], [4, 4]],
                [[0, 1], [0, 2], [1, 3], [2, 3], [2, 4], [3, 5], [4, 5]],
                [[0, 1], [0, 2], [1, 3], [2, 3], [2, 2], [3, 5], [4, 5]],
            ];
            var getTransformableNumberPath = function(_, x, y, s) {
                return num_path[_ % 10].map(function(n) {
                    return {
                        x0: x + (n[0] % 2) * s,
                        y0: y + (n[0] >> 1) * s,
                        x1: x + (n[1] % 2) * s,
                        y1: y + (n[1] >> 1) * s,
                    };
                });
            };
            var drawTransformingNumber = function(context, m_, n_, trans, x, y, s, p, line_num) {
                line_num = line_num || 10;
                p = p || 0;
                var p_2 = p * 0.5;
                var q0 = 0.3;
                var c = getTransformableNumberPath(m_, x, y, s), d = getTransformableNumberPath(n_, x, y, s);
                var n = [];
                for(var i = 0; i < d.length; i++) {
                    n.push({
                        x0: bbb.math.lerp(c[i].x0, d[i].x0, trans),
                        y0: bbb.math.lerp(c[i].y0, d[i].y0, trans),
                        x1: bbb.math.lerp(c[i].x1, d[i].x1, trans),
                        y1: bbb.math.lerp(c[i].y1, d[i].y1, trans),
                    });
                }
                context.beginPath();
                for(var j = 0, length = n.length; j < length; j++) {
                    if(n[j].x0 == n[j].x1 && n[j].y0 == n[j].y1) continue;
                    var q = Math.sqrt((n[j].x0 - n[j].x1) * (n[j].x0 - n[j].x1) + (n[j].y0 - n[j].y1) * (n[j].y0 - n[j].y1)) / s * q0,
                        q_2 = q * 0.5;
                    for(var i = 0; i < line_num; i++) {
                        context.moveTo(
                            n[j].x0 + (Math.random() * p - p_2) * s,
                            n[j].y0 + (Math.random() * p - p_2) * s
                        );
                        context.quadraticCurveTo(
                            (n[j].x0 + n[j].x1) * 0.5 + (Math.random() * q - q_2) * s,
                            (n[j].y0 + n[j].y1) * 0.5 + (Math.random() * q - q_2) * s,
                            n[j].x1 + (Math.random() * p - p_2) * s,
                            n[j].y1 + (Math.random() * p - p_2) * s
                        );
                    }
                }
                context.strokeStyle = '#fff';
                context.stroke();
            }
            return drawTransformingNumber;
        })();
        function drawColon(context, x, y, size, perc, line_num) {
            if(perc < 0.5) return;
            context.beginPath();
            for(var i = 0; i < line_num; i++) {
                context.moveTo(x + size * 0.5 - Math.random() * 10, y + size * 0.5 - Math.random() * 10);
                context.lineTo(x + size * 0.5 + Math.random() * 10, y + size * 0.5 + Math.random() * 10);
                context.moveTo(x + size * 0.5 - Math.random() * 10, y + size * 0.5 + Math.random() * 10);
                context.lineTo(x + size * 0.5 + Math.random() * 10, y + size * 0.5 - Math.random() * 10);

                context.moveTo(x + size * 0.5 - Math.random() * 10, y + size * 1.5 - Math.random() * 10);
                context.lineTo(x + size * 0.5 + Math.random() * 10, y + size * 1.5 + Math.random() * 10);
                context.moveTo(x + size * 0.5 - Math.random() * 10, y + size * 1.5 + Math.random() * 10);
                context.lineTo(x + size * 0.5 + Math.random() * 10, y + size * 1.5 - Math.random() * 10);
            }
            context.stroke();
        } 
        function drawDot(context, x, y, size, perc, line_num) {
            if(perc < 0.5) return;
            context.beginPath();
            for(var i = 0; i < line_num; i++) {
                context.moveTo(x + size * 0.8 - Math.random() * 10, y + size * 1.8 - Math.random() * 10);
                context.lineTo(x + size * 0.8 + Math.random() * 10, y + size * 1.8 + Math.random() * 10);
                context.moveTo(x + size * 0.8 - Math.random() * 10, y + size * 1.8 + Math.random() * 10);
                context.lineTo(x + size * 0.8 + Math.random() * 10, y + size * 1.8 - Math.random() * 10);
            }
            context.stroke();
        }
        var drawString = {
            ":": drawColon,
            ".": drawDot,
        };
   </script>
    <script>
        var draws = [
            function draw_circled_triangles(context) {
                this.rect(0, 0, this.size.width, this.size.height);
                this.clear();
                for(var i = 0; i < 10; i++) {
                    var s = Math.min(this.size.width, this.size.height) * 0.16 * (1.5 + Math.sin(this.frame * 0.001));
                    var sx = Math.cos(Math.PI * 0.25 + this.frame * 0.01) * s,
                        sy = Math.sin(Math.PI * 0.25 + this.frame * 0.01) * s,
                        ex = Math.cos(Math.PI * 0.75 + this.frame * 0.011) * s,
                        ey = Math.sin(Math.PI * 0.75 + this.frame * 0.011) * s,
                        cx = this.center.x,
                        cy = this.center.y;
                    this.setStrokeColor(255, 255, 255, 127);
                    for(var i = 1; i <= 20; i++) {
                        this.beginPath();
                        this.setFillColor(255, 255, 255, 32);
                        var d = (Math.random() - 0.5) * this.scroll_pos,
                            x = Math.cos(this.frame * 0.003 * i) * s * (1.5 + Math.cos(this.frame * 0.01 + d)),
                            y = Math.sin(this.frame * 0.003 * i) * s * (1.5 + Math.cos(this.frame * 0.01 + d));
                        this.lineTo(cx + sx, cy + sy);
                        this.lineTo(cx + x, cy + y);
                        this.lineTo(cx + ex, cy + ey);
                        this.closePath();
                        this.fill();
                        this.stroke();
                    }
                }
            }, // draw_circled_triangles
            function draw_perlin_particles(context) {
                this.setFillColor(0, 0, 0, 32);
                this.rect(0, 0, this.size.width, this.size.height);

                // this.context.lineWidth = 0.3;
                var color_flick = 127 * this.scroll_pos;
                for(var i = 0; i < 400; i++) {
                    this.beginPath();
                    var gray = 255 - Math.random() * color_flick;
                    this.setStrokeColor(gray, gray, gray, 128);
                    var x = this.px(i),
                        y = this.py(i);
                    this.line(this.points[i][0], this.points[i][1], x, y);
                    // this.point(x, y);
                    this.points[i][0] = x;
                    this.points[i][1] = y;
                    this.stroke();
                }
            }, // draw_perlin_particles
            function draw_perlin_rects(context) {
                this.clear();
                // this.setFillColor(0, 0, 0, 10);
                // this.rect(0, 0, this.size.width, this.size.height);
                this.setStrokeColor(255, 255, 255);
                // this.indecies.forEach(function(index) {
                //     this.point((bbb.noise.perlin3(index[0] * 0.01, index[1] * 0.01, this.frame * 0.01) + 1.0) * this.size.width * 0.5,
                //                (bbb.noise.perlin3(index[0] * 0.01, index[1] * 0.01, 1.0 + this.frame * 0.01) + 1.0) * this.size.height * 0.5);
                // }, this);
                var w = this.size.width / this.grid_size,
                    h = this.size.height / this.grid_size;
                var ps = Math.cos(Math.PI * 0.5 * bbb.noise.perlin2(this.scroll_pos, this.frame * 0.01));
                var len2 = this.size.width * this.size.width + this.size.height * this.size.height;
                this.indecies.forEach(function(index) {
                    var s = ps * (bbb.noise.perlin3(index[0] * 0.01, index[1] * 0.01 + this.scroll_pos, this.frame * 0.01) + 1.0) * 0.5;
                    var x = (index[0] + 0.5) * w, y = (index[1] + 0.5) * h;
                    var dx = x - this.mouse.x, dy = y - this.mouse.y;
                    var d = Math.max(0.0, ((dx * dx + dy * dy) / len2 * 1.5));
                    s *= Math.pow(Math.sin(Math.PI * 0.5 * d), 0.11432);
                    // this.setStrokeColor(s * 128, s * 128, s * 128);
                    // this.strokeRect(x - s * w * 0.5, y - s * h * 0.5, s * w, s * h);
                    this.setFillColorHSV(this.frame % 400 * 0.0025, this.scroll_pos * 0.5, 0.5);
                    this.rect(x - s * w * 0.5, y - s * h * 0.5, s * w, s * h);
                }, this);
            }, // draw_perlin_rects
            function draw_clock(context) {
                this.clear();

                var date = new Date(),
                    hour = date.getHours(),
                    min = date.getMinutes(),
                    sec = date.getSeconds(),
                    msec = date.getMilliseconds();
                var last_time = [
                    hour * 0.1 ^ 0, hour % 10,
                    ":",
                    min * 0.1 ^ 0, min % 10,
                    ":",
                    sec * 0.1 ^ 0, sec % 10,
                    ".",
                    (msec * 0.01) ^ 0, (msec * 0.1) ^ 0 % 10, msec % 10
                ];

                date = new Date(date.getTime() + 1000);
                hour = date.getHours();
                min = date.getMinutes();
                sec = date.getSeconds();
                var current_time = [
                    hour * 0.1 ^ 0, hour % 10,
                    ":",
                    min * 0.1 ^ 0, min % 10,
                    ":",
                    sec * 0.1 ^ 0, sec % 10,
                    ".",
                    (msec * 0.01) ^ 0, (msec * 0.1) ^ 0 % 10, msec % 10
                ];

                var org_progress = msec * 0.001;

                var progress = bbb.math.clamp(org_progress * 1.2 - 0.1, 0.0, 1.0);
                var sined = Math.sin(progress * Math.PI - Math.PI * 0.5);
                var transition = (sined < 0.0 ? -0.5 : 0.5) * Math.pow((sined * sined), 0.1) + 0.5;

                var size = this.size.width / (last_time.length + 6);
                var offset = 30;
                var left = (this.size.width - ((size + offset) * last_time.length - offset)) * 0.5;
                var line_num = this.scroll_pos * 10 + 1;

                for(var i = 0; i < last_time.length; i++) {
                    if(drawString[last_time[i]]) {
                        drawString[last_time[i]](
                            context,
                            left + (size + offset) * i,
                            this.size.height * 0.5 - size,
                            size,
                            progress,
                            line_num
                        )
                    } else {
                        drawTransformingNumber(
                            context,
                            last_time[i],
                            current_time[i],
                            transition,
                            left + (size + offset) * i,
                            this.size.height * 0.5 - size,
                            size,
                            1.0 - this.scroll_pos,
                            line_num
                        );
                    }
                }
            }, // draw_clock
        ];
        var hash = window.location.hash.replace('#', '');
        var draw_index = bbb.math.clamp((hash == '') ? (draws.length - 1) : (0 ^ hash), 0, draws.length - 1);
        $(function() {
            var fragments = [];
            for(var i = 0; i < 100; i++) fragments.push('<p>dummy text ' + i + '</p>');
            $("#dummy_contents").append(fragments.join(''));

            for(var i = 0; i < draws.length; i++) {
                $('select').append('<option' + ((i == draw_index) ? ' selected' : '') + ' value="' + i + '">' + draws[i].name + '</option>');
            }

            bbb.noise.seed(Math.random());
            var renderer = new bbb.canvas.renderer(
                document.getElementById('canvas'), {
                    properties: {
                        indecies: (function(grid_size) {
                            grid_size = grid_size || 64;
                            var arr = [];
                            for(var i = 0; i < grid_size; i++) {
                                for(var j = 0; j < grid_size; j++) {
                                    arr.push([i, j]);
                                }
                            }
                            return arr;
                        })(64),
                        grid_size: 64,
                        ease_x: 0.0,
                        ease_y: 0.0,
                        points: [],
                        px: function(i) {
                            return (bbb.noise.perlin3(i * 0.01, Math.cos(i) * 0.1 + this.ease_x * 0.01, this.frame * 0.001) + 1) * this.size.width * 0.5;
                        },
                        py: function(i) {
                            return (bbb.noise.perlin3(i * 0.01 + this.scroll_pos, Math.sin(i) * 0.1 + this.ease_y * 0.1, this.frame * 0.001) + 1) * this.size.height * 0.5
                        },
                    },
                    setup: function(context) {
                        for(var i = 0; i < 400; i++) {
                            var x = (bbb.noise.perlin3(i * 0.005, i * 0.005 + this.ease_x * 0.005, this.frame * 0.001) + 1) * this.size.width * 0.5,
                                y = (bbb.noise.perlin3(i * 0.005, i * i * 0.005 - this.ease_y * 0.005, this.frame * 0.001) + 1) * this.size.height * 0.5;
                            this.points[i] = [x, y];
                        }
                    },
                    update: function(context) {
                        var p = 0.95;
                        if(this.ease_x == 0 && this.ease_y == 0) {
                            this.ease_x = this.mouse.x;
                            this.ease_y = this.mouse.y;
                        }
                        this.ease_x = this.ease_x * p + this.mouse.x * (1.0 - p);
                        this.ease_y = this.ease_y * p + this.mouse.y * (1.0 - p);
                    },
                    draw: draws[draw_index],
                }
            );

            $('#menu').change(function() {
                var index = 0 ^ $('#menu option:selected').val();
                renderer.set_draw(draws[index], true);
                window.location.hash = index;
                $('#code_example').text(draws[index].toString());
            });
            $('#code_example').text(draws[draw_index].toString());

            renderer.start();
        });
    </script>
</body>
</html>